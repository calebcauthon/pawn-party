<script src="lib/jquery.144.js"></script>
<script src="lib/qunit.js"></script>
<link rel="stylesheet" href="css/qunit.css" />

<body>
  <h1 id="qunit-header">QUnit example</h1>
 <h2 id="qunit-banner"></h2>
 <div id="qunit-testrunner-toolbar"></div>
 <h2 id="qunit-userAgent"></h2>
 <ol id="qunit-tests"></ol>
 <div id="qunit-fixture">test markup, will be hidden</div>
</body>

<script type="text/javascript" src="lib/square.js"></script>
<script type="text/javascript" src="lib/board.js"></script>
<script type="text/javascript" src="lib/piece.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	var is_white = function(image_data) {
			if(image_data.data[0] == 0 &&
			image_data.data[1] == 0 &&
			image_data.data[2] == 0)
				return true;
			else
				return false;
		}
	var is_not_white = function(image_data) {
		return is_white(image_data) ? false : true;
	}
	
	test('board.draw() draws all the squares it has in .squares', function() {
		
		var canvas = $('#board_test_1').get(0);
		var context = canvas.getContext('2d');
		
		var black = 'rgb(0,0,0)';
		var white = 'rgb(255,255,255)';
		
		var squares = [];
		
		for(var i=1;i <= 8; i++)
		{	
			var left = i * 32 - 32;
			var color = (i % 2) == 0 ? black : white;
			var this_square = new square();
			this_square.set_context(context);
			this_square.left = left;
			this_square.top = 0;
			this_square.color = color;
			this_square.width = 32;
			this_square.height = 32;
			this.was_drawn = false;
			this_square.draw = function() {
				this.was_drawn = true;
			}
			squares.push(this_square);
		}
		
		var a_board = new board();
		a_board.squares = squares;
		
		a_board.draw();
		
		for(var i=0;i < squares.length; i++)
		{
			equals(squares[i].was_drawn, true);
		}
	});
	test('board class exists', function() {
		var a_board = new board();
	});
	
	test('square.draw_image(path) draws an image anchored at .left and .top', function() {
		var canvas = $('#canvas_element_5').get(0);
		var context = canvas.getContext('2d');
		
		var a_square = new square();
		a_square.set_context(context);
		a_square.width = 10;
		a_square.height = 10;
		a_square.left = 60;
		a_square.top = 90;
		
		a_square.color = 'rgb(0,0,0)';
		a_square.draw_image('images/chesspieces/black-pawn.png');
		
		var raw_canvas = $('#canvas_element_6').get(0);
		var raw_context = raw_canvas.getContext('2d');
		
		var img = new Image();
		img.src = 'images/chesspieces/black-pawn.png';
		img.onload = function() {
			raw_context.drawImage(img,0,0);
			var pixels = raw_context.getImageData(5,5,25,25);			
			var other_pixels = context.getImageData(65,95,25,25);
			
			for(var i=0;i<100;i++)
			{
				if(pixels.data[i] != other_pixels.data[i])
				{
					alert('test failed, check console');
					throw "pixels arent equal on "+i;
				}
			}
		}
	});
	test('square.draw_image(path) draws an image', function() {
		var canvas = $('#canvas_element_3').get(0);
		var context = canvas.getContext('2d');
		
		var a_square = new square();
		a_square.set_context(context);
		a_square.width = 10;
		a_square.height = 10;
		a_square.left = 0;
		a_square.top = 0;
		
		a_square.color = 'rgb(0,0,0)';
		a_square.draw_image('images/chesspieces/black-pawn.png');
		
		var raw_canvas = $('#canvas_element_4').get(0);
		var raw_context = raw_canvas.getContext('2d');
		
		var img = new Image();
		img.src = 'images/chesspieces/black-pawn.png';
		img.onload = function() {
			raw_context.drawImage(img,0,0);
			var pixels = raw_context.getImageData(5,5,25,25);			
			var other_pixels = context.getImageData(5,5,25,25);
			
			for(var i=0;i<2500;i++)
			{
				if(pixels.data[i] != other_pixels.data[i])
				{
					alert('test failed, check console');
					throw "pixels arent equal on "+i;
				}
			}
		}
	});
	test('square.draw() uses its .left and .top attributes', function() {
		var canvas = $('#canvas_element').get(0);
		var context = canvas.getContext('2d');
		
		var a_square = new square();
		a_square.set_context(context);
		a_square.left = 133;
		a_square.top = 727;
		a_square.width = 5;
		a_square.height = 5;
		
		var pixel_before_drawing = context.getImageData(133, 727, 1, 1);
		a_square.draw();
		var pixel_after_drawing = context.getImageData(133, 727, 1, 1);
		
		equals(is_white(pixel_before_drawing), true, 'pixel should be white');
		equals(is_not_white(pixel_after_drawing), true, 'pixel should not be white');
	});
	test('square.draw() fills the square with its color', function() {
		var canvas = document.getElementById('canvas_element');
		var context = canvas.getContext('2d');
		
		var a_square = new square();
		var color = 'rgb(33,25,199)';
		
		a_square.color = color;
		a_square.set_context(context);
		a_square.width = 10;
		a_square.height = 10;
		a_square.left = 10;
		a_square.top = 10;
		a_square.draw();
		
		var pixel = context.getImageData(13,13,1,1);
		equals(pixel.data[0], 33);
		equals(pixel.data[1], 25);
		equals(pixel.data[2], 199);
		equals(is_not_white(pixel), true, "pixel should not be white");
	});
	test('square.draw() uses the width and height properties of itself', function() {
		var canvas = $('#canvas_element').get(0);
		var context = canvas.getContext('2d');
		var a_square = new square();
		a_square.set_context(context);
		
		var width = 10;
		var height = 99;
		var x = 33;
		var y = 22;
		a_square.width = width;
		a_square.height = height;
		a_square.left = x;
		a_square.top = y;
		a_square.draw();
		
		var pixel = context.getImageData(x, y, width-1, height-1);
		
		equals(is_not_white(pixel), true, 'pixel should not be white');		
	});
	test('square.draw() uses an ioc canvas context', function() {
		var this_canvas = $('#canvas_element').get(0);
		var this_context = this_canvas.getContext('2d');
		
		var that_canvas = $('#canvas_element_2').get(0);
		var that_context = that_canvas.getContext('2d');
		
		var this_square = new square();
		this_square.set_context(this_context);
		
		var that_square = new square();
		that_square.set_context(that_context);
		
		var x = 12;
		var y = 99;
		var width = 4;
		var height = 5;
		this_square.width = width;
		this_square.height = height;
		that_square.width = width;
		that_square.height = height;
		
		var this_pixel_before_draw = this_context.getImageData(x, y, width-1, height-1);
		var that_pixel_before_draw = that_context.getImageData(x, y, width-1, height-1);

		equals(is_white(this_pixel_before_draw), true, "this pixel is white before draw");
		equals(is_white(that_pixel_before_draw), true, "that pixel is white before draw");
		
		this_square.left = x;
		this_square.top = y;
		this_square.draw();		
		var this_pixel_after_this_draw = this_context.getImageData(x, y, width-1, height-1);
		var that_pixel_after_this_draw = that_context.getImageData(x, y, width-1, height-1);
		equals(is_not_white(this_pixel_after_this_draw), true, "this pixel is not white after this draw");
		equals(is_white(that_pixel_after_this_draw), true,  "that pixel is white after this draw");
		
		that_square.left = x;
		that_square.top = y;
		that_square.draw();
		var this_pixel_after_that_draw = this_context.getImageData(x, y, width-1, height-1);
		var that_pixel_after_that_draw = that_context.getImageData(x, y, width-1, height-1);
		equals(is_not_white(this_pixel_after_that_draw), true, "this pixel is not white after that draw");
		equals(is_not_white(that_pixel_after_that_draw), true, "that pixel is not white after that draw");
	});
	test('square.draw() throws an error if it doesnt have a context', function() {
		var a_square = new square();
		raises(a_square.draw, "expected an error, didnt get one");
	});
	test("square.draw() draws blank square if theres no piece", function() {
		var canvas = $('#canvas_element').get(0);
		var context = canvas.getContext('2d');
		
		var a_square = new square();		
		a_square.set_context(context);
		equals(a_square.has_piece(), false);
		
		var x = 4;
		var y = 34;
		var width = 5;
		var height = 5;
		a_square.width = width;
		a_square.height = height;
		var bottom_right_x = parseInt(x, 10) + parseInt(width, 10) - 1;
		var bottom_right_y = parseInt(y, 10) + parseInt(height, 10) - 1;
		
		

		var canvas = $('#canvas_element').get(0);
		var context = canvas.getContext('2d');
		
		var upper_left_corner_before_drawing = context.getImageData(x, y, 1, 1);
		var bottom_right_corner_before_drawing = context.getImageData(bottom_right_x, bottom_right_y, 1, 1);

		a_square.left = x;
		a_square.top = y;
		a_square.draw();
	
		var upper_left_corner_after_drawing = context.getImageData(x, y, 1, 1);
		var bottom_right_corner_after_drawing = context.getImageData(bottom_right_x, bottom_right_y, 1, 1);

		equals(is_white(upper_left_corner_before_drawing), true);
		equals(is_white(bottom_right_corner_before_drawing), true);
		equals(is_not_white(upper_left_corner_after_drawing), true);
		equals(is_not_white(bottom_right_corner_after_drawing), true);
	});
	test("square.set_piece() sets a chess piece", function() {
		var a_square = new square();
		var rook = new generic_chess_piece();
		
		equals(a_square.has_piece(), false);
		a_square.set_piece(rook);
		equals(a_square.has_piece(), true);
	});
	test("a square class exists", function() {
		var a_square = new square();
	});
	test("a basic test example", function() {
		ok( true, "this test is fine" );
		var value = "hello";
		equals( "hello", value, "We expect value to be hello" );
	});

});
</script>

<canvas id="board_test_1" height="300" width="300"></canvas>

<canvas id="canvas_element" height="1000" width="1000"></canvas>
<canvas id="canvas_element_2" height="1000" width="1000"></canvas>
<canvas id="canvas_element_3" height="1000" width="1000"></canvas>
<canvas id="canvas_element_4" height="1000" width="1000"></canvas>
<canvas id="canvas_element_5" height="1000" width="1000"></canvas>
<canvas id="canvas_element_6" height="1000" width="1000"></canvas>
